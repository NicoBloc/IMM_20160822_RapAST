---
title: "Supplemental Figure 1: Development of zone diameters of wild-type and non-wild-type populations over time"
author: "Marion Jetter, Nicolas Blöchliger, Michael Hombach*\\newline Institute of Medical Microbiology, University of Zurich, Gloriastrasse 30/32, 8006 Zürich, Switzerland"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  pdf_document:
    number_sections: true
    toc: true
---


```{r loadLibs, echo=FALSE, warning=FALSE, message=FALSE}
source("../../Scripts/helper.R")
```



```{r readData, echo=FALSE, warning=FALSE, cache=TRUE}
dRaw <- read.csv("../../Data/Daten_für Nico_rapid_AST_Paper_V7.csv", header=TRUE, sep=';', na.strings='') %>% gather('h', 'diameter', 4:7)
dRaw <- dRaw[!is.na(dRaw$diameter), ]
dRaw <- dRaw[!is.na(dRaw$phenotypes), ]

dRaw$organism <- revalue(dRaw$organism, c("Escherichia coli"="E. coli", "Enterobacter cloacae"="E. cloacae", "Klebsiella pneumoniae"="K. pneumoniae", "Staphylococcus aureus"="S. aureus", "Staphylococcus epidermidis"="S. epidermidis"))

dRaw$antibiotic <- revalue(dRaw$antibiotic, c("Kanamycine"="Kanamycin"))

dRaw$h <- as.numeric(gsub("[a-z.]", "", dRaw$h))

dRaw$phenotypes <- substring(dRaw$phenotypes, 2)  # removes leading ";"
# dRaw$phenotypes[is.na(dRaw$phenotypes == "")] = 'NA'
dRaw$phenotypes <- factor(dRaw$phenotypes)

nPt <- max(lengths(strsplit(levels(dRaw$phenotypes), ';')))
dRaw <- dRaw %>% separate(phenotypes, sep=";", into=paste0("phenotype", 1:3), fill="right") %>% gather("tmp", "phenotypes", 4:6, na.rm=TRUE) %>% select(-tmp)
dRaw$phenotypes <- factor(dRaw$phenotypes)

dRaw$checkin <- factor(dRaw$checkin)

dRaw$hDiscr <- factor(round(dRaw$h))

dRaw <- droplevels(dRaw)
```



```{r, echo=FALSE, warning=FALSE, fig.height=5.5, results='asis'}
masterLoop(manuscript=2)
```

# Auxillary figure for Fig. 2 (main text)

```{r, echo=FALSE, warning=FALSE, fig.height=8.5, results='asis'}
dRaw$phenotypeGroup <- revalue(dRaw$phenotypes, c(
  "AmpC hyperproduction"                   ="aquired AmpC or AmpC hyperproduction",
  "aquired AmpC"                           ="aquired AmpC or AmpC hyperproduction",
  "high level resistance"                  ="high level quinolone resistance",
  "KPC"                                    ="class A carbapenemase (KPC type)",
  "low level resistance"                   ="low level quinolone resistance",
  "multiple mechanisms"                    ="multiple aminoglycoside resistance mechanisms",
  "NDM"                                    ="class B beta-lactamases (NDM and VIM type)",
  "non-wild-type"                          ="non-wild-type without specified mechanism",
  "other beta-lactamases*"                 ="other beta-lactamases (non-ESBL, non-AmpC, non-carbapenemase)",
  "OXA-48"                                 ="class D beta-lactamases (OXA-48 type)",
  "RND pump"                               ="RND-pump mediated efflux",
  "VIM"                                    ="class B beta-lactamases (NDM and VIM type)",
  "cMLS"                                   ="constitutive ermMLS",
  "Efflux"                                 ="tetB efflux and/or ribosomal protection",
  "iMLS"                                   ="inducible ermMLS",
  "lnu"                                    ="lnu-gene"))

stopifnot(dRaw %>% group_by(organism, checkin, antibiotic, hDiscr, phenotypeGroup) %>% summarise(count=n()) %>% filter(count == 4) %>% nrow == 0)  # checks that strains with multiple phenotypes are listed at most once per phenotypeGroup. Currently commented since this is violated.
if (dRaw %>% group_by(organism, checkin, antibiotic, hDiscr, phenotypeGroup) %>% summarise(count=n()) %>% filter(count != 1) %>% nrow != 0){
  cat("\n\nWARNING: DATA NOT CLEAN\n\n")
}
```

```{r, echo=FALSE, warning=FALSE, fig.height=8.5, results='asis'}
tmpNonWt <- dRaw %>% filter(phenotypeGroup != "wild-type") %>% group_by(organism, antibiotic, phenotypeGroup, hDiscr) %>% summarise(q95=quantile(diameter, 0.95))
tmpWt <- dRaw %>% filter(phenotypeGroup == "wild-type") %>% group_by(organism, antibiotic, hDiscr) %>% summarise(q05wt=quantile(diameter, 0.05))
dFig2 <- left_join(tmpNonWt, tmpWt, by=c("organism", "antibiotic", "hDiscr")) %>% mutate(wellSeparable=(q05wt > q95), group=factor(c("Enterobacteriaceae", "staphylococci"))[organism %in% c("S. aureus", "S. epidermidis") + 1]) %>% group_by(group, antibiotic, phenotypeGroup, hDiscr) %>% summarise(wellSeparable=factor(mean(wellSeparable)))
tmp <- setdiff(levels(dFig2$wellSeparable), c("0", "1"))
tmp2 <- rep("separability differs among species", length(tmp))
names(tmp2) <- tmp
dFig2$wellSeparable <- revalue(dFig2$wellSeparable, c("0"="not separated", "1"="well separated", tmp2))
dFig2$antibiotic <- factor(dFig2$antibiotic, levels=levels(dFig2$antibiotic)[rev(c(20, 1:7, 16, 21, 24,   8, 14, 18, 19,        12, 13, 27,    25, 17, 26,     10, 9,      11, 22, 15,    23))])

dFig2$phenotypeGroup <- factor(dFig2$phenotypeGroup, levels=levels(dFig2$phenotypeGroup)[c(6, 21, 2, 9, 12, 16, 20, 19, 10, 14, 5, 4, 3, 1, 15, 22, 17, 8, 7, 11, 13, 18)])

cnt <- 1
for (g in levels(dFig2$group)) {
  pandoc.header(paste(sep="", "Fig. ", cnt, " (main text): ", g), 1)
  print(dFig2 %>% filter(group == g & hDiscr %in% c("8", "18")) %>% ggplot(aes(x=hDiscr, y=antibiotic, colour=wellSeparable)) + facet_grid(. ~ phenotypeGroup, drop=TRUE) + geom_point(size=2) + xlab('time / h') + theme(legend.position="top", strip.text.x=element_text(angle=90)) + scale_colour_manual(values=c("skyblue4", "orangered3", "orange")) + guides(colour=guide_legend(title="separability from wild type", title.position="top", title.hjust=0.5)))
  ggsave(paste(sep="", "Figs/fig", cnt, ".png"), width=18, height=18, units="cm", dpi=1200, limitsize=TRUE)
  cat("\n\n")
  cnt <- cnt + 1
}
```

\newpage

# Fig. 3 (main text)

```{r, echo=FALSE, warning=FALSE, fig.height=8.5, results='asis'}
tab2()
ggsave(paste(sep="", "Figs/fig3.png"), width=18, height=20, units="cm", dpi=1200, limitsize=TRUE)
```
